<!-- public/dashboard.html -->
<!doctype html>
<html class="h-full bg-gray-50">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard — Hash Reports Over Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    .chart-box { position: relative; width: 92vw; max-width: 1200px; height: 300px; margin: 0 auto; }
  </style>
</head>
<body class="h-full text-gray-900">
  <header class="border-b border-gray-200 bg-white/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="text-lg font-semibold">Dashboard</div>
      <nav class="flex items-center gap-3">
        <a class="text-sm text-blue-700 hover:underline" href="/reports/latest/">Latest Report</a>
        <select id="report-picker" class="text-sm border border-gray-300 rounded-md px-2 py-1">
          <option value="" selected>Select Report</option>
        </select>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <section class="rounded-2xl bg-white shadow border border-gray-100 p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Overall Hashrate (PH/s)</h2>
        <div class="text-xs text-gray-500" id="range-stamp"></div>
      </div>
      <div class="mt-4 chart-box"><canvas id="chart-hashrate"></canvas></div>
    </section>

    <section class="rounded-2xl bg-white shadow border border-gray-100 p-5">
      <h2 class="text-xl font-semibold">Weather — Sylvania, GA (Current Temp at Snapshot Time)</h2>
      <div class="mt-4 chart-box"><canvas id="chart-temp"></canvas></div>
    </section>
  </main>

  <script type="module">
    // Manifest + picker wiring
    async function getManifest() {
      try {
        const r = await fetch('/reports/index.json', { cache: 'no-cache' });
        return r.ok ? r.json() : { reports: [] };
      } catch { return { reports: [] }; }
    }

    function wireReportPicker(manifest) {
      const sel = document.getElementById('report-picker');
      if (!sel) return;

      const reports = (manifest && manifest.reports) ? manifest.reports : [];
      // Preserve the first "Select Report" option; clear anything else.
      sel.innerHTML = '<option value="" selected>Select Report</option>';

      if (!reports.length) {
        // Show a disabled item if nothing to list
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'No reports found';
        none.disabled = true;
        sel.appendChild(none);
      } else {
        reports.forEach((r) => {
          const opt = document.createElement('option');
          opt.value = r.path;
          opt.textContent = r.label || r.path;
          sel.appendChild(opt);
        });
      }

      sel.addEventListener('change', () => {
        if (sel.value) location.href = sel.value;
      });
    }

    // Helpers for chart
    async function getReportJson(path) {
      const r = await fetch(path + 'hash-report.json', { cache: 'no-cache' });
      if (!r.ok) throw new Error(r.status);
      return r.json();
    }

    const hashCtx = document.getElementById('chart-hashrate');
    const tempCtx = document.getElementById('chart-temp');

    (async function () {
      const manifest = await getManifest();
      wireReportPicker(manifest);

      const entries = (manifest.reports || []).slice(0, 60); // last 60 snapshots
      const data = [];
      for (const e of entries) {
        try {
          const j = await getReportJson(e.path);
          const t = new Date(j.generatedAt || e.generatedAt || Date.now());
          const phs = Number(j && j.overall ? j.overall.current_phs : NaN);
          const temp = Number(
            (j && j.weather && j.weather.sylvania && j.weather.sylvania.current && j.weather.sylvania.current.temperature_f) ??
            (j && j.weather && j.weather.sylvania && j.weather.sylvania.sylvania && j.weather.sylvania.sylvania.current && j.weather.sylvania.sylvania.current.temperature_f) ??
            NaN
          );
          data.push({ t, phs, temp });
        } catch { /* skip this entry on error */ }
      }
      data.sort((a, b) => a.t - b.t);

      if (data.length) {
        const first = data[0].t, last = data[data.length - 1].t;
        const rs = document.getElementById('range-stamp');
        if (rs) rs.textContent = first.toLocaleString() + ' → ' + last.toLocaleString();
      }

      new Chart(hashCtx, {
        type: 'line',
        data: {
          labels: data.map(d => d.t.toLocaleString()),
          datasets: [{ label: 'PH/s', data: data.map(d => d.phs), tension: 0.3, pointRadius: 0, borderWidth: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: data.map(d => d.t.toLocaleString()),
          datasets: [{ label: 'Temp °F', data: data.map(d => d.temp), tension: 0.3, pointRadius: 0, borderWidth: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    })().catch(console.error);
  </script>
</body>
</html>
